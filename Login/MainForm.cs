using Game.DataBase;
using Game.Network;
using Game.Network.Email;
using Game.Network.JSON;
using System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Windows.Forms;

namespace Login
{
    public partial class MainForm : Form
    {
        public TcpSvr ts;
        public MsSql mssql;
        public Hashtable PlayIDVarPool;
        public Boolean DebugShow = true;
        public MainForm()
        {
            InitializeComponent();
        }
        private void toolStripMenuItem1_Click(object sender, EventArgs e)
        {
            this.Show();
            this.WindowState = FormWindowState.Maximized;
        }
        private void toolStripMenuItem2_Click(object sender, EventArgs e)
        {
            this.Hide();
            this.WindowState = FormWindowState.Minimized;
        }
        private void MainForm_SizeChanged(object sender, EventArgs e)
        {
            if (this.WindowState == FormWindowState.Minimized)
            {
                this.Hide();
                this.notifyIcon1.Visible = true;
            }
        }
        private void toolStripButtonStart_Click(object sender, EventArgs e)
        {
            switch (toolStripButtonStart.Text)
            {
                case "Start Server":
                    toolStripButtonStart.BackColor = Color.Blue;
                    toolStripButtonStart.Image = Login.Properties.Resources.connect_no_128px_14813_easyicon_net1;
                    toolStripButtonStart.ImageTransparentColor = Color.Transparent;
                    //toolStripButtonStart.BackgroundImage = Login.Properties.Resources.Blue;
                    toolStripButtonStart.Text = "Stop Server";
                    PortNo.Enabled = false;
                    ts = new TcpSvr(Convert.ToUInt16(PortNo.Text), 4096, new Coder(Coder.EncodingMothord.UTF8));
                    //ts = new TcpSvr(Convert.ToUInt16(PortNo.Text), 4096, new Coder(Coder.EncodingMothord.HexString));
                    //ts.Resovlver = new DatagramResolver(Convert.ToChar(4).ToString());//EOT (end of transmission)
                    PlayIDVarPool = new Hashtable(4096);
                    ts.ServerFull += new NetEvent(ServerFull);
                    ts.ClientConn += new NetEvent(ClientConn);
                    ts.ClientClose += new NetEvent(ClientClose);
                    ts.RecvData += new NetEvent(RecvData);
                    ts.HeadLength = true;
                    ts.Start();
                    if (DebugShow) rtbe1.SetText(string.Format("Server is listen{0} Start", ts.ServerSocket.LocalEndPoint.ToString()), true);
                    listView2.Items.Clear();
                    SocketStatus.Text = String.Empty;
                    SocketStatusLabel.Text = String.Empty;
                    SessionCount.Text = String.Format("Current count of Client is {0}/{1}", ts.SessionCount, ts.Capacity);
                    break;
                case "Stop Server":
                    toolStripButtonStart.BackColor = Color.Red;
                    toolStripButtonStart.Image = Login.Properties.Resources.connect_established_128px_14214_easyicon_net1;
                    toolStripButtonStart.ImageTransparentColor = Color.Transparent;
                    //toolStripButtonStart.BackgroundImage = Login.Properties.Resources.Red;
                    toolStripButtonStart.Text = "Start Server";
                    if (DebugShow) rtbe1.SetText(string.Format("Server is listen{0} Stop", ts.ServerSocket.LocalEndPoint.ToString()), true);
                    PortNo.Enabled = true;
                    ts.Stop();
                    listView2.Items.Clear();
                    SocketStatus.Text = String.Empty;
                    SocketStatusLabel.Text = String.Empty;
                    SessionCount.Text = String.Empty;
                    ts.Dispose();
                    PlayIDVarPool = null;
                    break;
                default:
                    break;
            }
            startServerToolStripMenuItem.Text = toolStripButtonStart.Text;
        }
        private delegate void AddItemCallback(object o);
        private delegate void DelItemCallback(String o);
        private delegate void UpdItemCallback(String o, String oo);
        private delegate void UpdItemCallbackB(String o, String oo);
        public void AddItem(object o)
        {
            if (this.listView2.InvokeRequired)
            {
                AddItemCallback d = new AddItemCallback(AddItem);
                this.Invoke(d, new object[] { o });
            }
            else
            {
                // code that adds item to listView (in this case $o)
                if (o is ListViewItem)
                    listView2.Items.Add((ListViewItem)o);
                else if (o is string)
                    listView2.Items.Add((string)o);
            }
        }
        public void DelItem(String o)
        {
            if (this.listView2.InvokeRequired)
            {
                DelItemCallback d = new DelItemCallback(DelItem);
                this.Invoke(d, new object[] { o });
            }
            else
            {
                ListViewItem foundItem = listView2.FindItemWithText(o, false, 0, true);
                if (foundItem != null)
                {
                    listView2.TopItem = foundItem;
                    listView2.FindItemWithText(o, false, 0, true).Checked = true;
                    listView2.FindItemWithText(o, false, 0, true).Selected = true;
                    listView2.FindItemWithText(o, false, 0, true).Focused = true;
                    listView2.Focus();
                    listView2.SelectedItems[0].Remove();
                }
            }
        }
        public void UpdItem(String o, String oo)
        {
            if (this.listView2.InvokeRequired)
            {
                UpdItemCallback d = new UpdItemCallback(UpdItem);
                this.Invoke(d, new object[] { o, oo });
            }
            else
            {
                ListViewItem foundItem = listView2.FindItemWithText(o, false, 0, true);
                if (foundItem != null)
                {
                    listView2.TopItem = foundItem;
                    listView2.FindItemWithText(o, false, 0, true).Checked = true;
                    listView2.FindItemWithText(o, false, 0, true).Selected = true;
                    listView2.FindItemWithText(o, false, 0, true).Focused = true;
                    listView2.Focus();
                    listView2.SelectedItems[0].SubItems[3].Text = oo;
                }
            }
        }
        public void UpdItemB(String o, String oo)
        {
            if (this.listView2.InvokeRequired)
            {
                UpdItemCallbackB d = new UpdItemCallbackB(UpdItemB);
                this.Invoke(d, new object[] { o, oo });
            }
            else
            {
                ListViewItem foundItem = listView2.FindItemWithText(o, false, 0, true);
                if (foundItem != null)
                {
                    listView2.TopItem = foundItem;
                    listView2.FindItemWithText(o, false, 0, true).Checked = true;
                    listView2.FindItemWithText(o, false, 0, true).Selected = true;
                    listView2.FindItemWithText(o, false, 0, true).Focused = true;
                    listView2.Focus();
                    listView2.SelectedItems[0].SubItems[4].Text = oo;
                }
            }
        }
        private void ClientClose(object sender, NetEventArgs e)
        {
            String PlayID = PlayIDVarPool[e.Client.ID].ToString();
            string info;
            
            if (e.Client.TypeOfExit == Session.ExitType.ExceptionExit)
            {
                info = string.Format("Client Session:{0} Exception Closed. PlayID:{1}", e.Client.ID, PlayID);
            }
            else
            {
                info = string.Format("Client Session:{0} Normal Closed. PlayID:{1}", e.Client.ID, PlayID);
            }
            //Console.WriteLine(info);
            //Console.Write(">");
            if (DebugShow) rtbe1.SetText(info, true);
            SocketStatus.Text = e.Client.ID.ToString();
            SocketStatusLabel.Text = info;
            //throw new NotImplementedException();
            DelItem(e.Client.ID.ToString());
            SessionCount.Text = String.Format("Current count of Client is {0}/{1}", ts.SessionCount, ts.Capacity);
            PlayIDVarPool.Remove(e.Client.ID);
        }
        private void ClientConn(object sender, NetEventArgs e)
        {
            string info = string.Format("Client:{0} connect server Session:{1}. Socket Handle:{2}",
            e.Client.ClientSocket.RemoteEndPoint.ToString(),
            e.Client.ID, e.Client.ClientSocket.Handle);
            PlayIDVarPool[e.Client.ID] = e.Client.ClientSocket.Handle;
            //Console.WriteLine(info);
            //Console.Write(">");
            if(DebugShow) rtbe1.SetText(info, true);
            SocketStatus.Text = e.Client.ID.ToString();
            SocketStatusLabel.Text = info;
            //throw new NotImplementedException();
            ListViewItem lvB = new ListViewItem();
            int lenIP = e.Client.ClientSocket.RemoteEndPoint.ToString().IndexOf(':');
            int lenPort = (e.Client.ClientSocket.RemoteEndPoint.ToString().Length - lenIP) - 1;
            String IPstring = e.Client.ClientSocket.RemoteEndPoint.ToString().Substring(0, lenIP).ToString();
            lenIP++;
            String PortString = e.Client.ClientSocket.RemoteEndPoint.ToString().Substring(lenIP, lenPort).ToString();
            lvB.Text = e.Client.ID.ToString();
            lvB.SubItems.Add(IPstring);
            lvB.SubItems.Add(PortString);
            lvB.SubItems.Add("Client Connect ... Ok!!!");
            lvB.SubItems.Add(String.Empty);
            AddItem(lvB);
            SessionCount.Text = String.Format("Current count of Client is {0}/{1}", ts.SessionCount, ts.Capacity);
        }
        private void ServerFull(object sender, NetEventArgs e)
        {
            string info = string.Format("Server is full.the Client:{0} is refused",
          e.Client.ClientSocket.RemoteEndPoint.ToString());
　　          //Must do it
　　          //服務器滿了，必須關閉新來的客戶端連接
　　          e.Client.Close();
            //Console.WriteLine(info);
            //Console.Write(">");
            if (DebugShow) rtbe1.SetText(info, true);
            SocketStatus.Text = e.Client.ID.ToString();
            SocketStatusLabel.Text = info;
            //throw new NotImplementedException();
            SessionCount.Text = String.Format("Current count of Client is {0}/{1}", ts.SessionCount, ts.Capacity);
        }
        private void RecvData(object sender, NetEventArgs e)
        {
            try
            {
                if (DebugShow) rtbe1.SetText(string.Format("from:{0} recv data:[{1}]", e.Client, e.Client.Datagram.Replace("\r\n", "")), true);
                SocketStatus.Text = e.Client.ID.ToString();
                SocketStatusLabel.Text = e.Client.Datagram.Replace("\r\n", "");
                UpdItemB(e.Client.ID.ToString(), String.Empty);
                UpdItem(e.Client.ID.ToString(), e.Client.Datagram.ToString());
                //if(DebugShow) rtbe1.SetText(Game.Network.Coder.ShowHexString(e.Client.Datagram), true);
                String ReturnString = LoginParser(e);
                //ReturnString += Convert.ToChar(4).ToString();
                TcpSvr svr = (TcpSvr)sender;
                //测试把收到的数据返回给客户端
                svr.Send(e.Client, ReturnString);
                if (DebugShow) rtbe1.SetText(string.Format("from:{0} send data:[{1}]", e.Client, ReturnString), true);
                //throw new NotImplementedException();
                SessionCount.Text = String.Format("Current count of Client is {0}/{1}", ts.SessionCount, ts.Capacity);
                UpdItemB(e.Client.ID.ToString(), ReturnString);
            }
            catch (Exception ex)
            {
                SocketStatusLabel.Text = ex.Message;
                String Datagram = "{\"methodName\":\"Error\",\"paramObject\":{\"Cord\":\"9999\",\"text\":\"";
                Datagram += ex.Message;
                Datagram += "\"}}";
                TcpSvr svr = (TcpSvr)sender;
                //测试把收到的数据返回给客户端
                svr.Send(e.Client, Datagram);
            }

        }
        public int testint = 0;
        public String LoginParser(NetEventArgs e)
        {
            //{"methodName": "registered","paramObject": {"firstName": "中文","lastName": "ok123","nickName": "中文ABC123","pwd": "thisIsPassword","birthday": "2017-01-01","email": "vvvv1@gmail.com","gender": 1,"country": "158","photo": 21845}}
            //{"methodName": "C2S_Login","paramObject": {"Account":"g9677602@gmail.com","Password":"a123736844","CheckPassword":"true"}}
            String ClientID = e.Client.ID.ToString(); 
            String Datagram= e.Client.Datagram;
            try
            {
                JsonData contentData = JsonMapper.ToObject(Datagram);
                e.Client.ID.VarPool["methodName"] = contentData["methodName"].ToString();
                JsonData paramObject = contentData["paramObject"];
                switch (e.Client.ID.VarPool["methodName"].ToString())
                {
                    case "registered":
                        if (paramObject.Count > 1)
                        {
                            e.Client.ID.VarPool["FirstName"] = paramObject["firstName"].ToString();
                            e.Client.ID.VarPool["LastName"] = paramObject["lastName"].ToString();
                            e.Client.ID.VarPool["MicknName"] = paramObject["nickName"].ToString();
                            e.Client.ID.VarPool["password"] = paramObject["pwd"].ToString();
                            e.Client.ID.VarPool["Birthday"] = paramObject["birthday"].ToString();
                            e.Client.ID.VarPool["BirthYear"] = e.Client.ID.VarPool["Birthday"].ToString().Split('-')[0].ToString();
                            e.Client.ID.VarPool["BirthMonth"] = e.Client.ID.VarPool["Birthday"].ToString().Split('-')[1].ToString();
                            e.Client.ID.VarPool["BirthDay"] = e.Client.ID.VarPool["Birthday"].ToString().Split('-')[2].ToString();
                            e.Client.ID.VarPool["email"] = paramObject["email"].ToString();
                            e.Client.ID.VarPool["location"] = paramObject["gender"].ToString();
                            e.Client.ID.VarPool["Gender"] = paramObject["country"].ToString();
                        }
                        String Sql_Registered = @"";
                        e.Client.ID.VarPool["ErrorCord"] = C2S_Registered_SQL(Sql_Registered);

                        Datagram = "{\"methodName\":\"registered\",\"paramObject\":{\"rs\":\"";
                        Datagram += e.Client.ID.VarPool["ErrorCord"];
                        Datagram += "\",\"photo\":\"";
                        if (testint == 0)
                        {
                            Datagram += "FFD8FFE000104A46494600010100000100010000FFDB0084000906071313121512131215151216151215151517100F101215151615161615151515181D2820181A251B151521312125292B2E2E2E171F3338332D37282D2E2B010A0A0A0E0D0E171010152B1D171D2B2D2B2B2B2B2D2B2B2D2D2D2D2D2D2B2D2D2D2D37372D372D2D2D2D37373737372B2D2B2D2B2D2B2B2B2B2D2B2B2B2B2B2BFFC000110800B7011303012200021101031101FFC4001C0000010501010100000000000000000000040102030506000708FFC400391000010302030506050304020301000000010002030411052131124151617106228191B1F01332A1C1D10742E1142362F1335234728216FFC400190100030101010000000000000000000000010203000405FFC40020110101010100020300030100000000000000011102213103124122617151FFDA000C03010002110311003F00C7FBF24AD3F64D3BFDEF5C0FBF15C4EB4A3DFAA7B0A801F7D7F8520723282509ED2A30548D1EAB6D6C4A0A918F515931C8EB625A99800B39883F6DCD8C7EE758F41AAB3AF758741F5D556E0B1ED48E79D1A364753A94D02CF2D140DB0B6E03D344AE5CD3926B8A0C42534B921728DEFB7BF1584B21C90B248BA594A12491603A5932F7E2508F93DFA7905D249EFD07DD0EE7FBE3FECA7902A407DFA0FBA0AAA5B9D91A0D7EE9F5336C8E7F74201E675E898AE277F2B0E8873AA91EECCF0B25A688BC868D511F67450171B0473281E05ED90456C18B469F2BA9A0C4646E6F610CE36164B7CA9920CC1646B8EC9C8AD751C0382CCC14EC92CF6E47968B5186680148AF37C2D218EC14B649184E28B61428E44E4D7942995D587259DC402D0D62A1AD667E2B724A1E959915351332775B792750346C93CCFD13607EC445DC4923C4A6C4BAAE32F3FAAE55523DE493F65C894E2B81F7E095DAFBE8908FBAE78A1DFCFA256951A75D164CC77BE8A66942B0FD94ED72CC9EE9094CBA64F258146B2AB1CA8B03C4A3706A7D96346F3DE3D4AA57FF007670DDC0DCAD2C5E89AF885F69DCE5138A52E51BDC974708F721A59174AF414B2FF1F64CD4E965E285964FE7D4A6C927BE9A7D50EF7FBF7CD3730873DDEFD546F75B3F1FC242FF00A65F942CCF2EC93B1A1DB46E74095C52DAD928E5766881918D569BB15866DED3C8DF61E0B2EC76ABD5BB1B47B30332CC8BF9A1DDF07F8E685C4B0B26D61C1557696021AC0DCDA1A72FF2BFE17A04B4D7081A9A26BB2734152E7AC56F3AF3AC1247B5C06E3AF006F92DEE199A81F85B1B6B36C01BD869757184D2A36EB73320D633242D54DB2ACE56582A5AF980D56A315F26381A7BC085C31E89D95D574F5D093636F30A13470BF436F108C85FB4594B5CD76842AAAB9AD73C2FE682ABC2DCDCD8F2ABAA2A1E2CC3E3D7409A17AB8D0507FE393BCDEDE254588641910DC038F8683CFD119045B31319BED73EAABA592E5D21DFA0E434F34C9DA67C468C89CD720DD236FDEF9B7AE58BA1595D9E7CFD51715403F45635D854721BDB65DC465E637AA5A9C3248FE5EF36DA8C8DBA2E7F156CB075FDF825B2A98EB883628D654828658DA241FBA707FBEBFE944D9134B91114C721314A8B34A735CAAB1696F90DF97994799B42A6C0E3F9A4E26C3C35FAABE8F455F44CD86B5A370FF68FDA5BABB5B98E73D412C8964720679509069B3CC8491FEFDF2BA6C927AA81CF54913B5CF75FDF92613EFE890BAFA247BAC2DBF794ED21933F704D8C6F4C68BF44F71583497B67EEEA071C8F3524A741E6A390230B51C7AD97B76011DA260FF16FA2F108CF78750BDD30477F6D9FFA8F44BF22DF0FEAD5AD504ED0A6748ABEA67CD456C46F6DCAB8A082C105410DCABE8E1B353F3CE97BB8AFAD595C4E9B69D9DF656AEA33557554E804BF8F39ED3D1B58FEEB45801A6F3C55353CB2374BDAD723805E9588E10C9466331E0B3789612E60B35A00E3737B712A9F625E0241896D305CFBE6A0A08FE2CDC8665072D318EFCF72B3C0FBA1CEF774642F5E971249727CBC15557CB6BF06DB2E7A0089A99B6197B5CEE1C49D020F0E836DDDECDACEF38FFD9FC9325A268B0B1B00B8778DC9EA493F75C8ECB792172CCE0FBDF3E29AE725922CC9EAA37E4B8DD41AAA81926A05F8E8554D4E0EF6E6C3B43868EF0574943D36863322A1CD367020F03929E3AA07DF8AB9A88DAFC9C2FE0AAE6C17FE8EB1E074F34FECB9615F364AB23EFCA380CCFD92564724770E0473D479A4C2DD605C77A693216DF2BCDBB27FC7E68033029A5EA7861734EABA796E9647A165727E605AE25346795AE7800494B030BCD8641593EBBE0B4B2300388B39F9175B9704C339FDAAB7923AE96E0A071DC12C8FBF5F79A6B06F4D13EA9FA256E42FEEE9ACCCAE9DD97BD56FD6FC423E64B3E8BA98669B5477233D97F0334AF6BECBD4ED53C6EE2C6AF13017A5FE9F575E0D8BE6C24781CC25F93D29F0DF2DCBDC8460BB97473DD0E652D7DED929475634F8742AC2AF26AA6A3C4D8066E08FA8AE616137DD92E8E6C9CA3D4B6AB8CB7364F2DBA0A175CDD1EC513DE43BA055B8952F749E4AF485518E4A1AC3D0AD80F33ED003B7B235390EA8DA060CA31A346D3CEEE9D4955B5B597949199D1BD78A26A5FF000D82207BEEEF3CF016CEFE8ADCC73FC97C92AEAB6DF76EEEEB39BB7BBC15BD340236FC31A8F98F177F0ABB07833F896B06E4C1CF8FDD59BB4EBEC9EA53E6A69193002DB20F35C9F1B721A2E472004A5C62393226C7783AF34448D0743D16424D97656B1B9CD741552C77D9712381CD71FD1D5AD43A03F9E8A0208DC85A2ED034E4E041FA79AB3350C70163F73E096CC1942B64F24AE2887440E9A0D6DF8514ACB656B67E3D0F92CC6992F91171C372AFA8C3E377CA364F2D3C910E0744C7BAD9A32D6C52D451C8CCC778711F85032A38ABEF8881C483367BC05F71191BFDD3CBA4B15F2D40039F050D3C4E7BB3D4EE4C8DB7289326CF75BA9C89DFD02769FF006889AA4463619F37EE76FE8382AF7BCEED575D26C2D0BD5D31B7295E7704E3968BA18EE6FC3D531644CD65821E6CD16FD14B8751ED3AE46410D3DE77C078E1D90A39A1BABBA9A5CDAD03326C3AA9E6C1DB136F23FBDB80171D00D4A1A6BC4657E072577D8F9CB27D9BE4F04788D136686F9E83771F152609487E287F0216DF059CE5D6C1D3BDAEB0D355674759B43BDFCA8DD497B39412417D6E398C923D3E2CB3CAF69A99AE19668C8A902CE504EF89D91DA6F5CD685B88348591F939CBE1308ECA46B942D9AEA1A8A9006A84A989A8A9002F3CED963D7FEDB4E66FE489ED2F6876416839EE0B0A1C5EE2E71B954912EFBCF4330F3B00CAED7F6A7D244E91F6D4BB371E48232ED1E4DF55A7C1693619B67E6764D558E6F63DB18166019347FB5CF3BCEECFF84F78B65BCEBD10B592EC8E9EA9CB485E379375C878A32403C57220CC17E653DB2A81FAF9AE2B9B1D12A6D906FB9490973736BAC7E885BA91B29196E42C1D5AD36385B93DBE238F30ACA0C41925ECE04E5C8F3D5664BEEB9D16796485E20EB5263C8E798D77A1DCDF5C82A88EBA566A769B96B9FD5170E2AC3F3774F31F4092F26D3DF60A92B27DA75B82B1C4AADA1B76EFF554E079EF4FCC2F54E1C026DB825272B0CCFA2221809C80B94DA126A16B7CD23CA32A83631619BCEA787208127CD19E4BD783436FEF445C51DBDEA99046890DDC3558FC7246445EE0005ABC1301924B35BDD6FEE75B21FCA2BB27D982FEFBC6CB35BF1E416CDD66B76231B2C1C35292D37F8C7625873239A264773B21C4939DCF15598A521DBDA3995A87D3DEA01B7ED3EAA6AEC3811A2169FC30EE87685ACAC70DA2D9B228D0ECBB44753C287E157346D05A13DF460A160796F44632B07141697C7841FD081B9325002755624D0A82BF12274582D594F8BB58165F1AED238E4D41E235478AA42368927E51A9E3C9539E52EBA432B8B8DC9B9BA6B9DB92B9DE1C12462E78AAC737556780D1191E05B219B96C4817BEE6E4DE1CCFD9058251FC2887FDDDAF8A2E476561EFD94FCF9A17C2373FCD54D4C9B4ED919D8F8928EAD9765BE76416151ED3AE779CBF29A91A1A1C3098DA6C74FBAE5B7C370D1F09996E5C975B5E00FF00CA6B92B8E67C575D415204B7D53414A0A22707250E4C484AC3A9C4C98F20A809480AD8DA75ADBD7037C8265AEADB06C21D2BB20767A216E1B99A6617873A43668EAEE0AD710D8A76EC33E73BF7857758F8E922D96DB6B8E5974E2562AA252F71275F349CF9F2A75E262070B9B94F6457E9EAA68A25798276766A8700D610DE36C93DB89CE7F6AAA0849B002EE3A05BEECB763434096A0730CFCAD2E03D918A946D386D4BCC0247456AF8C9D7C3829DEE1FDFA0521BE4059A340324CF84ACD94C92686C14FEC38A4FE9BBE1C887C7708931E57504853FB656CD440E6876416571643CD120C10C6849A328E2879C84065C55CEC5555AEB69AAB3AC9967EAEEFE9BC714F19553DDE78FD078724256E56015D08ADA79AA6C447795794BBA0D5CF66E8048FDA77CA153B46816CB0484322BEF213FA4A45AC8FDE3A0E1C1436BF409FA01EF542D7CBB3191BDC9B90E9575F26D1E5BBA71563D9687E24EC034B8FA2AA9E2EE171CAF603905A7EC041799BC91D2D7ADC1100D0380095111C7905C86931F291B5CF8A42523F5F35C1497295C917202529A575D212B01852829A53C3730D02EE36007344641D83D1195E1BBB795E82EF87490EDBBBA0E4D1FBDE780E0154D0D5434110160E9C8B91AE7C0ACE6215B24EFDB91C49DC340D1C00DCA597ABFD3A67F186E235CE99E5C74DC370FE5253539710D68249D2C3353E1D44E95ED8E36ED3DC6CD68DE7F1CD7B8764BB0F0D346D2F0D7CFFB9FC0F06F24D7ACF04BFDB2DD87EC39BEDD4301047C847CB9DC1BF15E8D4D44C846CB00BFA23DAC0C6F7421C052EBA6F684C57CCE678A8DF1224A615310FB2A09588B7285EB41574911B2AF91B9FF00B56F2C805B2073CFBC1B6E07355B56769CE36734171B075AF6000BE5B8E6AF24C4FED7731104C9029765216A53ABE58D56D634D95F3D884A88568CC9CD0927351BE2002BAA9A5559353926C33255256AAC7C05D9054D8ED1FC3D9E26F7E1BAC3EA56D4D33616173FE6B67CB90590C7E52F734E833B0E0324F13B35530B2EE039AD8C43BA1A3880B2D8637BF73BAE7F0B494AEF9071B94D69641D23BF0809FBF206EE6FAA22A65B143E186F25B7924A32875098DB036360DE5C47805AEFD38A6EF8255076B60D8318DC3BC3A90B5BFA711E77D537E255E8ED8D72903C703E4910C2BE4773733E29AA57EA426153548B815C35CF4E2A6961005DAF0E1E20F91585014D29FB29CD6A1B06736A36B7804550B4B1DB43E6DDBEDCD4D434A5E4774DBCAEB5B86F67B791653EBB91D1C7C6CF5361EF79B9BE66E77927AA9AA686CE6C6C177123AE6B63252B62693C1683B0DD9B6B49AA945E477FC6D3FB46BB479A59D6A9D7813FA7FD90FE99826900F88E197F8B4EEEA56F020F6C9364680839FABA1DE6E534AE714974944D2A3715212A3720646E513D4AF2A07944434CC0502F8EC72C91CF42CA134AD621B28C95214C2894C2A37354A531C8B029A0BA5148D85A5EED7DE415C52D3868DB7782A5C61C5E6FB956782EEF8667137990DCE9B870FE567F168086DF815A2AA6D954E286EC211167A98D9A799FA2BEA77D8B39355244372B164B930F328D2E0CA87687AA86824D99D9C14B95BA1F5414BDD783CC2303A8D2F6F5BFDC88EE2C69F15B0FD346E5758DED2547C5A7A77EF1DC3E0B63FA5CFBB4F82788DF4F45D95C9D73C972C93E467EA7C535CBD1E93F4BA43FF24C0726B73FAABFC3BF4DA9999BEF21FF002397905CDD7CD23B67C2F1EA6A47C87663639CEE0D04AD5E11FA7755258C968C70F99FE5B97AFD060D1442CC8DAD1C804708C051EBE6B7D2BCFC7CC61F0AFD3BA78EC5CDDB77171BFD15EFFF009BA702DF0983FF0090AEEEA19A451FB5BFAA462712ECD32376DC600B6EE4961392D1D63AE0AA29A3B232A91052527C6998C39B6FB4EE166E76F45BD81A069E5B82C97669BFDD71E0D03CD6B5A6D9ABC88F7EC547ADFA29E779D02129DD7BA9A5934E28A384484A4DA48528B8A8DC9495148E4051C8F50B9C9934A9B19BAC6C388504CD45ECA6BD88C0565930A2658ECA22D4C542515454BB599D024A7A62E36475510C1B01539C9E4977D4035D25CD868ABA782EAC36535C12DEBC9A4C65ABA8D6771082DB96F6AA1BAA0C428AE9E7438C03D9671088873674289C5A8AC76BAA1699D6F14C51F4A6E6DC426574595FC0A6B0DBC11EE2080771442A3A69B6E9A466A5843C74073FA2DDFE963FBC4723E4BCF6388C32075898DD7079B5D910B69FA5F2ECCDB37FDA475B6855221D47AF05C981CB96495964C72512377DF4C942F7AE3EBE3C77F3DE95CE4C73D0F24AA17CEA5D72B411248849A551493A0A7A849F5343E69557CEF0A3A9AB03326DD6C166318ED5C4CB86BB6DDC1BF9DCA9CFC7685EE4F6D8F67A76873C5F3C9691D22F17EC96333495CCE0EB8D9BD85B8F3392F5E6BEE15FEB88FDA75E56F4C720869E4B4857504B928F11201077E897A8DCFBC14D7A52F42C52649EE7A5AC91CF4254CFCD24B3AA6ADA92E218CCDC7CBA94B87E794ED9B69D61BB5E4ACE18ECA0C368831BCF79DE79A3C059AD25931CA429A4224A81CC51086E6C89D945431868DA3EFF00954E616D42EB44DFF23EFC955B9D7373AA7D554179B9F01C02124956E9A4C3DCF4D0E42BE74C35281B053F34054C4924AC1C50B25685A0FD55B89D087022CB1B534C63241D377E16FE405DA782A7C530DDA69B854E696C67217DFA84652BF71D0E9C8A05F198DD9E5B91111DFB8FD0A74EAEE81CD2361E3BA7CC1DC42BBEC9D1986A80DC77FA2CCC6EDFBF2BFE56B301ABEF34EA5BE6426DC2DF31EA6C76412212296ED0468405C9B5CB8ACA8A969B5811619F328596A922E52EDDBC4052D585595D8DC718BB8DBC1C7D172E51C5E3335DDBC885C3039C7A6C8FAACED7F6D277FC803079948B9538E625DF76282AB119643DF91C7C72F24286AE5CA92639EDB5BCFD38ECEBA526A8BACD8DDB2D00D8975B3BF25EA8D664B9724AAF22298D9331569201E0B9725BE8FCDFE41A0993DF32E5C914CF2ADAFAED905178451DBBCEF99D99E5C8745CB92D3F5E22E0275922E411D715C1AB97279004474E82C49E4F7770D572E5693C17F55F2B15754DD22E4B86D56544B6555535A42E5CB61A507FD4B89D51D4115CE6B972D4CBC8A3521A5042E5CA65AA7C57016BC12355939698C6F2C76874DF9255CADCD2749DBA7303CC7E5596135243C79A45C9D27A251626E0C68072B2E5CB92B63FFFD9";
                            testint++;
                        }
                        else
                        {
                            if (testint == 1)
                            {
                                Datagram += "FFD8FFE000104A46494600010100000100010000FFDB008400090607131312151213131516151717151818181818181D17181D17171818171517181A1E2820181D251D171721312125292B2E2E2E171F3338332D37282D2E2B010A0A0A0E0D0E1A10101A2D251F1D2D2D2D2D2D2D2D2D2D2D2D2D2D2F2D2D2D2D2D2D2B2D2D2D2D2D2D2D2D372D2D2B2D2D2D2D2D2D2D2D2D2D2D2D2D2D2D2D2DFFC000110800B7011303012200021101031101FFC4001B00000105010100000000000000000000000200010305060407FFC400421000010302030505060403060603000000010002110321041231054151619106137181A1223252B1C1D11442E1F053627207162392A2F115334382B2C2244454FFC4001A010101000301010000000000000000000000010203040506FFC4002B1100020201030401030305000000000000000102110312142104415161311315225281A105323371E1FFDA000C03010002110311003F00EB0C4418A44EBD9D47CDE823C89F2234413517411E44F951A74D43411E54F951A74D434001A9655224963491E44F951A4963401952CAA4492C6923CA96552274B2E922CA9655224963491654B2A953258D247952CA8D24B1A48F2A5951A4963481952CA8A5294B1A41CA9654529B32597483952CA9F304B384B26940E54E5A9670967096C521B2A6CA9FBC084D409C8A43E549377C124E4C69117E29BC52FC5B78AC67E2AAF1F4097E2AB71F41F65691754BD1B4FC5B78A5F8C6F158BFC556E27A0FB2638AADF11E83EC9486A97A36BF8C6F14FF008D6F158A189ABF11E83EC977F5BE277A7D9290D4FD1B5FC6B52FC6B562857ADF13BD13F7D57E27754A44D4FD1B4FC6B53FE35AB13DF55F89DD538AB57E277529486A66D7F1A131C6058C0EA9F13BFCC573E3368775EF3DD3F08719E8A3D295B2C7549D47966E8E37925F8DE4BCF86D2765CCFCCD6CC0973B31B4CC469E68D98E69D1E4CE801713E05A6F3E12B5FD6C66FDB66F06FBF1BC9238EE4B1349AE7096BB30E44C8E446E4E68BB9FAAD917197C1A6719C3FB8DA7E3F92138FF00058A3873C131C39E0B2A5E0C757B3687688E23AA13B487C4DEA163450E497E18F0F44A17ECD81DA8DF89BD4213B59BF1B3A8590343926FC3F24AF42FD9AD3B5D9FC4675084ED967F11BD5650D1E497729FB0BF66A4EDBA7FC4080EDDA7FC41D0FD9663BAE49CD13C13F61FB9A43B7A9FC7E87EC80EDFA7F11E85677BB29FBA42F1E4BF3B7E9FC4EE880F6829FF003F4FD5517747814DDCF24B1C792F1DDA06707FA7DD01ED037E17FA7DD53776782634D2C522E0F681BF03BA8407B41FC87AAAA148F0097707825B2D44B3FF008F9FE1FF00ABF44956F73E0925C89A606B1FD9CA80C659F020FD546761551FF4DDE60AF42AF81AAE372C0DDFACF918B7544DD9CFF8FCB77CA579BB99783D6D9E33CF2AEC378D18E361AB48F49F5435766B89BD22D16F75A7EA6EBD19B80A9BDCCF206DC35D517FC3A75783E49B9913678CF3F1B0D99F20A96890E2C3967E13C0AE8C3F646ABCC35CCE1336EA256DCECA69D483E4103B63D3FE51E4AEE244D9E3F062B1DD9375303FC463AA4FB83523716CEAABEA6C8A8DF7A9BC78823E8BD17FE10DD41E80CF5944CD9CE1A5578F09F94ABB964D8C0F341839D03BA4FD13BF0794FB61E391107D42F4E386A9FF00E87F46FD945568D71FFD831CD8CFB26E5936303C8B6D62C5268CB39DC61B3161BC9596A625DB8926E4DC9E31BCAB6ED86D335F12F797668391A600F65B6981A4DFA943D93A60B8B9C248D3CB45A32E6725A9F63B7A6E9638DE98F0D97BD9EECE56AA4778F0C61D19009836E169E0AEB69FF65D4F29731EF062468403E1C3CD5C6C30090E2B57F8E6658266172C723972DD1DB3C6A2D24ACF04C5ECFC4606A02749B384C386F0781F15B4C06C3AD598DA94D999AE00821CD8BF899565DA8A987C4D2A94E93C3EA34120341305B782E0201D45CEF5CDFD9AE2AB1C33994830E579BB8492080445F45D5D3E7944E1EB3A4C7917230EC9E2489EE5DD5BF74353B2F890DCC68BE395CF40656F30D5F1000CD4C1B68080278E5CC4A9D9B49CDB541009D403AF0112BA7732F479FF006FC7ECF37C36C0ACF98638709044A94F65315FC13E9F55E8CDDAD4CBB2CBF4D723E3C3342E8A78CA73ED5491C0B5C3E6137521F6E87B3C7ABE05EC716B9A5A46A0D8A8CE1CF25EC75F1D85DEE613CE27D74510760DCD03FC02381C9F259AEABD1ADFF4DF123C80E1DDC10F72EE0BD72861367B4CB7B99E6418F092A4184C1E8D146DCC2BBA5E09F6E7FA8F1F148F04BB93C17B67E0296E0C8E51FB850D7D8B847EADA73A5A01F4D5374BC0FB73FD478C7747826EE392F5FA9D9BC2441A607304FD0AE7FEE650CDBC378027EA9B944FB7CBC9E5470FC931C3725EB0EEC5E1E221D3C66E795EC1717F70E993FF0035C2FA40E92B25D4C43E82679A0C31FD84C28782F46A9D821062ADE6C0B7EB2A3FEE15A7BDBFF498F2BABB88F926CA7E0F3CEE5214BC17A00EC19303BD6FF97F55D0EEC1D3803BC7CF10047E8A6E23E46CA7E3F93CDFB9F0E83EC9D7A29EC0D3DD55FF00E9495DC47C93653F1FC9A0CDBA5207979A59C4C7D126B81FF6FBAF30F647CC135F927734F8F9C20CAEE410A1133A4240FEE3F729D8D317FB272DDF640418CC48A6DCC4388903D96971BEF81785231F2246FE447A1B84CE6CDF3441DD1D0CA72D9500C4AA3ED6638D2C35470F788CADF17587CFD15CBC80249F35E77FDA2ED819031BB8EB1A9822DE17D5632748CF1C6E47976D1A83BC806436DE3C568BB2B4410E74DE6152E1767663EFB64E82449F2D568364611F44C1061DA796AB0CAEA15674E08B793535C1DB8BC5B1B5052736ABA4493988DD395825AD2B51D91C24B43487B29D60EC81E7DB9DD233189F15D3B28D2A85A1E0081BB7AEADB38F6B2A512D10D61DC384442D1A938A3A5C5A93295F82C5B6B3285114D8C0F12F0D7668B136043488D41EAA0EC567C2ED1AD8481DDB8B8B472F79B6F03F35AF3B5CB9A6A86C30923A6A472BC792CDECB6779B5FBD1A36889F139C7C885B31C95D1A3345B8DB3D083FF728814CC3B922D9D42E93848EBD10E11713AC6A9DB4A3F338EBA9E3BAD01147249EF00817BF23F3161E684226618032046B6DD7D775FC51559DCD078C9FD14AE746E27C123E63F7E280E0707499C3B48E20B3E4541DF346773F0B918D1399C29DE35B02ADE13041655D2C4615DA775A811EC4DF4D1751D9F4BE0685D15B0CD77BCD6BBC403F35CD5766B6229FB0641B0313C48042725E071B3E98D0478177DD4ADA3CDDFE6747495C585D92DA6D80483BCB1CF68F26E6308A9E15ECF76AD5701B9EE69F52C24F556D8A4758A6E1A3DE3C1DF748078D2A3FD3EC84D72225A7C6447AC237D500804EBA704B2500C754B8EF5DAEF688F2917F24E5F53F887A46F9DC8DA67824E57531446FAB5B50F6CFF4FEA89F8CAF1A30E9C51420A4D747B4413FCA081D0929A89A413B4DE2D907F95DF64CA684E9A98D286BA401DE510081CF03531E3F2589445BE2135320DE67CD3466B875A469F2908B281A36FCA278EF4285035DFD754E0CF1F551B5EE248CA446F317E620FCD27B9D6812262D1239DCDD012440840F1E48E6CA373F92039318486923879F25E29DBAC78A95CB5A65ACB4EF27F31FA792F4FED76D614693A4992200E2780DE4F1E0BC4B1CF2E7133724FEBE4B0F991BA2AA3670B2A96B83C1820823C8AD5617B4ADA8D6D3753CAF2EF784064EEE778023C2EB2752F61E03EEBA29605EEF75A401A1FAAB921192E461C9383FC4F51D9D5838592DA556A173065960D48D45FE122FFBB2A5D92F2FA4DA80C3A21D1BC8B1B792BBC2631C20B984F317F45E727A65C9EB3FC95A2CF0149CF0477EF731804323D91B802F2D13E000D37AEBEC3B01AB89A8E101E599099821A1CCB4EBA03E6A1C16D7351DDD3599182EEB44CEEBF157CCDB4CBB5F122DE923D0ADD09A52B39B345C9517807828F15886D369738D80279DB92A9EFA9BAECB1E463E4829D4703A8778EBD755BBEBA39574CFC976C7820117044A626DC17035EDF8083C8DFCB8F95D10C4C45F303FBD566B22EE612C2FB1DED3FBBA8D9566626DC47C93D378224148B005B0D2D0B31F1F24F9929086B349D3E647C900F2792598FF00B14D3BBEFF0034C3C500D52A386827CE239A2CC50E6BC74B7D92C9799F2E3E3BD009D5210D47B47BC6278E8797094641E49AA53CC20807A7540735175179F6430B9BC0091CF8F9A9AA506B9B94891C0E89A9E1C0F8A78C9E33FBF046F8DC47540700ABDCDB2BB2EEBCC1263289B01A582E866264C6879831E4E16F252E61A4825135B1C10020BB9752924EA8DE1F249084D281D59A0805C012600E3BFE89E4FF00B21CA850062C4C105A741310EF0227A183C94C5E84531C9234D39046FAA46B31C6263C6069CD4AD70DD74529810100CE93C9576D4C739B0CA6335477BA370FE63C00E3FA03D589C4459A3338E8377893B82CD76941A54EE73BEA380304B469A5AF9774125632748CA11B661BB6F8E68FF0DAFEF1E67BCABFFA53E0D07A912B0B8836CA3CCAD3F6B5A19572344068BE9249B9240B0E4370859C6D3CCE60DC481F75AE0FB9D338F09169B0360BAAC3F46EE2778E4B435B66B5A3536E04AB6D974A1BE4A2C7B2C573CB2B6CED8618C552287B2B88CB99874307AFEA0AD360ABE5912B2BB270E5B500702DCCDB48E799A7CC3A55E774E1636E0468B0CCBF3B45E9FF00C6932C598ACA5C46F8F451E1E83DF521CE81509CA4E81CD6B4964F36C903F94AE7C352BC1BC29FB41891519149B95E329696EE2DD09F2B79AC60F9E4B922EB83ADD8C1407761D99DBCEEBEE0B89BB69ED74AE1C1541529E6FCD7CDC4386A0F9A8AA36E8F874CCA34D5A37586DBDDEB409D37EF458CDA111B8FCF9AC8E06A6582ACF6B92FA1DE37DEA7ED788FCC3A5FC93537C183C691AEC0631AE1C0AB2A6FDE6FCC6ABCE366ED9040BDD69305B5F9ADB0C8E3F273E4C2A5F06ABBC07429C15574F16C77228D950827DB244C8B3647102D71E2BA63953392585AF82C5328283C11EF6637B1107C3829C2DA9D9A5AAF9049DF087BD06C8F2F8A43C7D150302914E48E210E5FE640310984703E68B2F34E02108DCD1C13868DDEBF444E76FD07351071371948E20CFC901281E0928F39E1EA920B13EA35B73AF0913AF33CD336BCFE52391CB3E3627EE8C5113302749DFE089AC58F25384BBDA0D22A5C4E6CD0376E0419BF08B15D385A644B65C449209249B9D2FC14EE603FEC90252858C509609D4F97D78227392854113E9803D9039FDEDA9543B428F7B89A54C9CD926A38DBF28219EA5C7C82BAC6BEAB40EEDA1C660E6394347C56067C150ECEC0969AD8A73A6A196B00B34086C73B9F9F8AD723647C9E53DB2A99B155BFADDF323E8A8E81CB529FF501D6CADF6E381AD50EA33183E76FA2A2A87DA9E107CC2C71AB546FC8F4D33D4F679F65716D3C486900EF30149B1EACB0782E7DAF8135A29B63339CD6B66C249812775D70C55BA3D36E93671E2E9E534DFBB3869F0708FB2B4F69B6990B278AC6540D387788A99C3483A820C93E50B4381DA1DE36F670B3870216738B51566B84D39BAEE74974953D1A6157625DBD74ECFC4C85AE8DACAEDA0D7D2AD349A1C2A34B9CD9892D804B4F1823A2AF1B503AA3590E6B8B9A0822E2481E0AEBB4AE2D6B2AB449613D1CD22FE70B12492E9D4933E6BAF1E35356CF3F3669636E31EE6D28BA0969D4479820107CC10AE364D6B969B83623C562F0DB567105BBA1AD0771C822DC74F45A8C1558702B9B241C59D98E4A71B33D8E7F7159D49D683EC9E2D3769E9EB2BB7098E3A872D0EDC7D1EEBBCA986A75B4692496B9A0CE8E6DE248B7358AC552A6E23F0F4DD48F0CEE7CF2B8056F8E3D71B473CB2E895346AF0FB65C3556F81DBDB895E7C3115E9D9CCCDE1AF982BA68ED41F99AE69FE93F658BC725D8C94F1CBB9EA54B68B4EA577E0DF9C38F7AE041E237F0FD642F34C255A8E1EC36AB87114DE47A357A0763702F6532FA81C1EF3A38410D1A58E9249F45B316AD5469EA14143D97D46728CC41302481009DE40BC0F34E5F78E53EE98EBA4F245E287383A10BA8E00881C109604814D99503E508411C53E69BA6704016BCD24309F36E420BAA64CEAA071E8524202D79B4C46FE3CB449D5C73DDB8EF50BDC40923A4927C23551B33BA0B9B122E26E3840DFE77E4B0B33A3A5D566C09F28FAA139BE2B73D77EFD386E50BF10D6C036064498001F3D6797044F6990E07F5E1046974B07263082E199CE1178FE9DFEA068792EF638DAFE86D3A5A540CA7ED17113A4124785870D7532BA18F63AC0B4C6E041FAA88AC1AB54DF280799D078ACFEDE219488167F9C13B8F94B6FAEAB46E206E8E8BCE7B7BB665F91B68B4F5CC7FD447991B96391D233C4AD9E7DB42A5C954D50752BBF10E927C4F9DD586C0C25135186ABE24FB51F919BC9FE63263858EF487E28D993F2349D9E3EC37C07C959B9E1B529BBE17B0F4702ABB676218E739F4ECC73DE5A3834B8902375A175E3C7B27C171AE247A7F315FE88FFB57D88F6576E329FBA406BC8176B8583DDC8886F2CBCD62F03B49CC7E62730301DA4FFBAD66D9DB95B10C2C7D6395DA868005C5C1CBEF0E465636BECDA8D2728CC3746BD0AF43426B93C6D5283B4CD29C5B1ED96B8155B84DAE18F2D277AA7A7B36A93701BCC99F92EAA7B1C6F713E4DFB15AB6E8E9DE49D705D6D7DA61D41C266600E6641FA2AEECFEC97E22AB693233BB7EE60DEE27970E308A96C664FB45E794FE965EB7D88D90DC3E1E4B32BDE4B8883980D1A0EFE71CD651868546BCB93EA3D4CA9A1FD9AD18697D57E66E8581AD16D2C413EAB36F0EA6F7537D9CC25A7CB78E475F35E9F8CDB14E98BB6A13C031D98F80224F4585ED06CFAF8BAFDF52A3DC8CA03BBD7365F1A3B2B27298B5CEE1A2D39D26BE79377493716ED70C3D978A69203C0736448201044DC10755BD2D1DD9EE9ACD2034CB1B1CE018113BB72F39C3ECBAB44C3DCC3FD249F980BD1F63BB350A66058474B7D163D3BE5A32EB170A4739D9D4CB43EB61A8E6DF95B9FF00F504F451D3C4500FEEA9D26022265A1B00C7E5CB20DF781A8570CFA4C1D5455367D371CD972BC19CC203B76A778B0D5751C161B267929F2AE2A350F78F69D06521DC66416F8889FF00B97531E07E61D42A8816899C130A8D76878DB7F92E4AF86707E7A6E0D9F7DA5A487C686C46570889BC8B468A83A9AD84E934A70A818A14F99366420C90211168298346880599323C9CBD4264210920F1E298DC69FBE49DA33019810381B7C8A902C68C8E5A7841BE66759926DA9911E5A29DB404CDCF004D879290A53C528582EA6D8208041D41B8BEB32A0A74C32436986362646500927481795D0E78E21716D0C6526309A8E01BA5F7F845CA0333DB2ED19A4D8A6E6DE41327378706F88BAF26DAD8D2FA967170204988BEF00701A0F05BEED6D46D57B599B3D3170331304F3FA2A6A1846B7DC6341E3F658283F966ED692A4647F0554B8345370988241DFF00257547B3EE688739B1F9A265DC89DC390576C9B86FE9E299F45FAEBFBE03EAB6254617671609F91E58222644690787AAB5C7E2006C12A936982DA8D765CB222774EB13A6F2AF7B3BB2693FFC4C41CE750C9F647F571F0F9AE2CB151936CF4F0CDBC697829B0D433400092740264CEE8DEAFE8F64710E6CC319FCAE7438FF00DA263D1696B6CCC2551EE35A78B40691D35F35160367BF0ED731B57BC64976E155D3F94BB481C45FC16DDC2AE0E65D3F2ECA5FEE738B1C5AF639EDFC97FF00CB8ACED5C39612D70CA46A0D885B818934AA3731149A4FBAC32F74FC44D8F8C956D89C2B5CF07BB04FE52E024037D7728B3BEE25D3AECCC06CBD9B59C5AEA54DD20821D102C641936E8BD1B0F5B1264B8B183834491E2E363FE5082B631949A73182371F455B8BC4E25E26951A8E1BA465FF00CA21632CB297FC2C71457CFF00259B9AC65C9927524C92AA369ED86B742171B360E3EA9F683690FE67027A3655A613B134990FAAE75670DD1EC7F9778F12B0FA5297A3379B1C3BD9976E35D59E18C971240240710DB812ECA0C012BD230584752A4D631D98B45E6D989326E3DDB9E6A6C253B0DC204348023C40163C85ACBA882BA31E2503973677938EC566D1DA5DDD3EF0527BAD3940F6B749BF01B955E07B5D46A96B62A34B8C440969E0E178D45EE2EB4B087BB6CCE51237C5FAADA69B5E054D8019BF5FA6811C7042D26F6F0E6881DEA9017094A9B001172071327A9B9470B8EB542482D7B40DC72970F0306F22748FA103A5C1BC547481DE652C9220FA4B47CEDD54759C5B0402E130402091CE0EB7D6E809E37A17B79FA22A358917696F2313E84849B501E479D8A0236806E0F0FDFAA78331688F39951566BB337DD8067DA9F0910784D8F1E572EF0CFBA62267E91AA01024FECA484E2982C5E01E05C047529200D9317209E2040E92514C240A789133D100D9921E7B97355C3BCD46B855CAD1AB32825DC8BB70D345D246F403162E1C46C5A2F9969BEA039C073B030BB185C6E348363C41E52A5850146DECA6147FD2FF0053BEEA666C2C3304F72D3E32EE924AB273C0B92A3A06EE24933602D9401BDB69BF34B06636CF65B3B81A0032D7690E00DF71BC1E46372E1C1F646BBAF51C29F29CCEF4B7AADD649044D882A2A986CEDCAE2637E525B2375C5C7914B2D94B87D86293000C1520C924B0CD88321C39981C77F1A97F6718E71149CE63BDA9045DA6C45A4070BF2D6DA2D46170229B9B99F59E72903339C45B8B5BEC031BCDD77D4603620F5FB1958B827F2671C8E3F0CF30C67E270DFF0031BECCC078F74EFD7779F34F87DBB3AADD629CCA0E19BD8A6E75DCE3EC5C38E58BE5F3816EB49B63656CFC41396A5365571D69912E278B5BEF1F0BAE7974CBB1D71EB1F7436CFC636A30BA4100C41BAB9A01A60B5C4711A8F204DBC960F65E0EB51ADDD3FDC7831A1F748D1C3789B83712B5D85F649066D1BFD56BA7074CD8DAC8AD17F81C300DB96B899921997CA249EA4AE9A745A2C1AD03800005C34AA41026E418E71AFCD76B5D3A15D7092670648343D66C82226776EE6173D2C131B7022D100088E9F55D30A17B0EE23C0827E442CCD7603F174D9673837849F915D1DE8B0275D3EDE9E8A3A0D312624F09FAA2EEC11066F6D4837041BEB304A02574AE76E2BDACB0EBE840B73BEE3C8A94617DACD9CEEE531BFF007C1062185AD245FF00A8DA37EEB7A0F05412023970FD10B8C024C340BCC88F391651E1E99004DEC358D78DB8A98F8A010E36BF536E3A4D931336EBF5D13D3686D8081C0088F0FDEF4763B9015ACD9345B391805E61A5CD1D05BD176BBF7A7D51D4A4ABFF00F901CEB532D00E5B90E37B6E807A8F0407410E88B4F1FD23D110A7BFEDD10D22E26F0D1C20CF96EDDCD4F94DF770D2FF00BD1084507C7A27A266F275B8E1C955EDB7BE853756A633905A48701EE7E66C81206F924C428B606DD662010D696B81973490627788D5B3227AA16B82DEAE06938E67536127796827AC24A56926F749527205FC7E89D30452A01AC39A367EEDF24199057A7985890468418F3E07CC108527778AE6A945969124686E63CD135AE02F04F211D5306CEA8071CB45CADC3963896C969176CCC5F5688F2898D3CFAD9488B662473B9F09FBA38501CA09376C802C7335C0DF866833D54AC718E3F75354120C6B6F4DC7A2000DA409E467E6020183DDBCF4027A930B8EBE29E1ED6868B93F980B72E274DDC576B81126FD3E5CD04365B9849BC72E31D3E68522AEE6B9B96A530E1225A608F183AA54703487B94D8C9172D00183BA5BF75255A7ED82009B8322C45A7C0D874E8E1CEF8788991D78A10A0ED5E02037114D8269925F00662D200279C40D772E5AF8F02A527904D2AED23C1C381D6F3D656BE279ACFBBB301C1D45C477325D4C89EF2993B86E2D1D74F15AE70B767462CAA2A99153A2E71EE4BBFC5A7EDD371D4B4C86E61BC1820F316DCA4C2E2EAD50C7D0709CC5B55AE17646A403171A44DECAB5B84C43B292D70AD8739739B36AB49BB1A7981224EBE2AFB676CF8AA6BB1C5ADA977B1CDB920407033ECCEF9D6372C231766E9E4497C96ED09427482E83846129E10BDF17BF80DFC82E5AEFAD1EC1A60FC2E6B8F882E69F90EA80EC6BBF774ED7026DA8D5558C45780E8A44E85A0BF76B0E8D7965DE9F09B5A955032546662349123946BAA58A2CF2A8AB88048D427A15E403C4022E0EB179163AEE4F52A8E7C2C09EB0808B0D5839A1CD3ADF9F352F355E367815455048B384680CC6BCADA2EE081860A1791049F94FA0D5004E1E806A4F6900B4EA2DFEC7452E6281A77A6A35730D08E441047DFCAC840AA824102DCD5653D974DAF2F19B39FCF3C8580D00302D11E8AD106B041B20B18478A647E492A08DA6FAFEEDF7470924A0B04A6EF407359BDC091FF6C4FCD249084C4286B0804F0FD949240494DC08051A492005C1418AC48A6DCEEB3478EBBB449242A0E962330368B5D455DE1A5AC82E2F0E33311962FC77849250A895F403BDE13A1BF2E1CF9A918D8B04925496233368E7B8FEA951A81C245C491E60904750924A149085CCFC38D5A4B4F2D3CC6853A4A92CE7AB8A7D392F01CC1AB9BA8E65A75F2E8BAA8D60E008D0891AF9149250AC94A0492549647530CD37204F185CB8AD9549E21CD69E7027768750924A0B226ECC2C6E5A4E2D20CB4925F1FCB0E331BA253B31759A3DBA4D33BD8E11D1D052491F054ECEAC3627389820F0313E062CA5067775F22924888C70EBC6FD4796BF34CE7B410D362E36E640FB264950399421C9D2460769420891BF5BEFE69D24204132492A0FFFD9";
                                testint++;
                            }
                            else
                            {
                                Datagram += Game.Network.Coder.BytesToHex(File.ReadAllBytes("C:\\Users\\joseph\\Pictures\\lod.png"));
                                testint = 0;
                            }
                        }
                        Datagram += "\"}}";
                        break;
                    case "C2S_Login":
                        if (paramObject.Count > 1)
                        {
                            e.Client.ID.VarPool["account"] = paramObject["Account"].ToString();
                            e.Client.ID.VarPool["password"] = paramObject["Password"].ToString();
                            e.Client.ID.VarPool["CheckPassword"] = Convert.ToBoolean(paramObject["CheckPassword"].ToString());
                        }
                        //check DB Account / Password  Yes No
                        //Get DB [PlayID][Photo][GaneServer]
                        e.Client.ID.VarPool["ErrorCord"] = C2S_Login_SQL(e);
                        if (e.Client.ID.VarPool["ErrorCord"].ToString().CompareTo("00000000") == 0)
                        {
                            PlayIDVarPool[e.Client.ID] = e.Client.ID.VarPool["id"].ToString();
                            e.Client.ID.VarPool["Photo"] = Game.Network.Coder.BytesToHex((Byte[])e.Client.ID.VarPool["Photo"]);
                            e.Client.ID.VarPool["GaneServer"] = String.Format("192.168.0.149:8001");
                        }
                        else
                        {
                            e.Client.ID.VarPool["id"] = String.Empty;
                            e.Client.ID.VarPool["Photo"] = null;
                            e.Client.ID.VarPool["GaneServer"] = String.Empty;
                            e.Client.ID.VarPool["Photo"] = String.Empty;
                        }
                        Datagram = "{\"methodName\":\"S2C_Login\",\"paramObject\":{\"PlayID\":\"";
                        Datagram += e.Client.ID.VarPool["id"].ToString();
                        Datagram += "\",\"Photo\":\"";
                        Datagram += e.Client.ID.VarPool["Photo"].ToString();
                        Datagram += "\",\"ErrorCord\":\"";
                        Datagram += e.Client.ID.VarPool["ErrorCord"].ToString();
                        Datagram += "\",\"GaneServer\":\"";
                        Datagram += e.Client.ID.VarPool["GaneServer"].ToString();
                        Datagram += "\"}}";

                        break;
                    case "C2S_ForgetPassword":
                        if (paramObject.Count > 1)
                        {
                            e.Client.ID.VarPool["account"] = paramObject["Account"].ToString();
                        }
                        Random rnd = new Random();
                        e.Client.ID.VarPool["password"] = rnd.Next(0, 99999999).ToString().PadRight(8, '0');
                        //check DB Account Get Email
                        //write Password=GN

                        e.Client.ID.VarPool["ErrorCord"] = C2S_ForgetPassword_SQL(e);

                        Datagram = "{\"methodName\":\"S2C_ForgetPassword\",\"paramObject\":{\"ErrorCord\":\"";
                        Datagram += e.Client.ID.VarPool["ErrorCord"].ToString();
                        Datagram += "\"}}";
                        break;
                    default:
                        break;
                }
                //for (int i = 0; i < count; i++) 
                //{
                //    account = friendsData[i]["Account"].ToString();
                //    password = friendsData[i]["Password"].ToString(); 
                //}        
            }
            catch (Exception ex)
            {
                SocketStatusLabel.Text = ex.Message;
                throw ex;
            }
            return Datagram;
        }
        public String C2S_Login_SQL(NetEventArgs e)
        {
            String ReturnString = "00000000";
            try
            {
                if ((Boolean)e.Client.ID.VarPool["CheckPassword"])
                {
                    mssql.CommandString = String.Format("SELECT id, Mail, Photo FROM Account WHERE Mail='{0}' AND Password='{1}';", e.Client.ID.VarPool["account"].ToString(), e.Client.ID.VarPool["password"].ToString());
                }
                else
                {
                    mssql.CommandString = String.Format("SELECT id, Mail, Photo FROM Account WHERE Mail='{0}';", e.Client.ID.VarPool["account"].ToString());
                }
                if (!mssql.MsSelect(new string[] { "id", "Mail", "Photo" }, e.Client.ID.VarPool))
                {
                    ReturnString = mssql.ErrorCode;
                }
                //String id = MsSql.VarPool["id"].ToString();
                //String Mail = MsSql.VarPool["Mail"].ToString();
                //String Photo = Game.Network.Coder.BytesToHex((Byte[])MsSql.VarPool["Photo"]);
            }
            catch (Exception ex)
            {
                ReturnString = Convert.ToString(ex.GetHashCode());
            }
            return ReturnString;
        }
        public String C2S_Registered_SQL(String Data)
        {
            String ReturnString = "00000000";
            return ReturnString;
        }
        public String C2S_ForgetPassword_SQL(NetEventArgs e)
        {
            String ReturnString = "00000000";
            mssql.CommandString = String.Format("UPDATE Account SET Password='{0}' WHERE Mail='{1}';", e.Client.ID.VarPool["password"].ToString(), e.Client.ID.VarPool["account"].ToString());
            if (!mssql.MsUpdata())
            {
                ReturnString = mssql.ErrorCode;
            }
            else
            {
                Send emailsend = new Send();
                emailsend.smtpAddress = Login.Properties.Settings.Default.smtpAddress;
                emailsend.portNumber = Login.Properties.Settings.Default.portNumber;
                emailsend.enableSSL = Login.Properties.Settings.Default.enableSSL;
                emailsend.emailFrom = Login.Properties.Settings.Default.EmailFrom;
                emailsend.password = Login.Properties.Settings.Default.Emailpassword;
                emailsend.emailTo = e.Client.ID.VarPool["account"].ToString();
                emailsend.subject = Login.Properties.Settings.Default.subject;
                emailsend.body = String.Format(Login.Properties.Settings.Default.body, e.Client.ID.VarPool["password"].ToString());
                emailsend.SendEmail();
                if (emailsend.ErrorData.CompareTo("") != 0)
                {
                    ReturnString = emailsend.ErrorData;
                }
            }
            return ReturnString;
        }
        public string AssemblyVersion
        {
            get
            {
                return Assembly.GetExecutingAssembly().GetName().Version.ToString();
            }
        }
        private void MainForm_Load(object sender, EventArgs e)
        {
            String[] AA = Game.Network.Information.IPLocal();
            this.Text = "Login Server --- ";
            foreach (String s in AA)
            {
                if (s!=null) { 
                this.Text += "[";
                this.Text += s;
                this.Text += "]";}

            }
            this.Text += " --- Version:[";
            this.Text += AssemblyVersion;
            this.Text += "] ";
            mssql = new MsSql(Login.Properties.Settings.Default.ZLabSDBEntities);
            if (mssql.ErrorCode.CompareTo("00000000") != 0)
            {
                MessageBox.Show(mssql.ErrorMessing, mssql.ErrorCode);
                mssql.Dispose();
                mssql = new MsSql(Login.Properties.Settings.Default.ZLabSDBTestEntities);
                if (mssql.ErrorCode.CompareTo("00000000") != 0)
                {
                    MessageBox.Show(mssql.ErrorMessing, mssql.ErrorCode);
                    mssql.Dispose();
                    this.Close();
                }
            }
            PortNo.Text = Login.Properties.Settings.Default.ServerPort;
            if (Login.Properties.Settings.Default.AutoRun)
            {
                toolStripButtonStart_Click(sender, e);
            }
            DebugShow = Login.Properties.Settings.Default.DebugShow;
            if (DebugShow)
            {
                toolStripLabel1.Text = "Debug";
            }
            else
            {
                toolStripLabel1.Text = String.Empty;
            }
        }

        private void MainForm_FormClosed(object sender, FormClosedEventArgs e)
        {
            mssql.Dispose();
            if(ts!=null) ts.Dispose();
        }
    }
    public class RootObject
    {
        public string Function { get; set; }
        public List<string> Parameter { get; set; }
    }
}
